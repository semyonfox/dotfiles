# ======================================================================
# FUNCTIONS - FILE OPERATIONS
# ======================================================================

# Create directory and enter it
mkcd() {
    [[ $# -eq 0 ]] && { echo "Usage: mkcd <directory>"; return 1; }
    mkdir -p "$1" && cd "$1"
}

# Create backup of file
backup() {
    [[ $# -eq 0 ]] && { echo "Usage: backup <file>"; return 1; }
    cp "$1"{,.bak} && echo "Backed up: $1 → $1.bak"
}

# Find files by name
f() {
    [[ $# -eq 0 ]] && { echo "Usage: f <pattern>"; return 1; }
    find . -name "*$1*" 2>/dev/null
}

# Search text in files
ftext() {
    [[ $# -eq 0 ]] && { echo "Usage: ftext <pattern>"; return 1; }
    grep -rnw . -e "$1" 2>/dev/null
}

# Extract various archive formats
extract() {
    [[ $# -eq 0 ]] && { echo "Usage: extract <archive>"; return 1; }
    [[ ! -f "$1" ]] && { echo "Error: '$1' not found"; return 1; }

    case "$1" in
        *.tar.bz2)  tar xjf "$1" ;;
        *.tar.gz)   tar xzf "$1" ;;
        *.tar.xz)   tar xf "$1" ;;
        *.tar.zst)  tar xf "$1" ;;
        *.tar)      tar xf "$1" ;;
        *.tgz)      tar xzf "$1" ;;
        *.bz2)      bunzip2 "$1" ;;
        *.gz)       gunzip "$1" ;;
        *.rar)      unrar x "$1" ;;
        *.zip)      unzip "$1" ;;
        *.7z)       7z x "$1" ;;
        *.deb)      ar x "$1" ;;
        *)          echo "Error: Unsupported format '$1'" ;;
    esac
}

# ======================================================================
# FUNCTIONS - SSH
# ======================================================================

# Quick SSH connections
sssh() {
    case "$1" in
        server) ssh semyon@server ;;
        nas)     ssh server@nas ;;
        "" )      echo "Usage: sssh <server|hostname>"; return 1 ;;
        *)       ssh "$1" ;;
    esac
}

# Zsh completion for sssh
_sssh_complete() {
    local hosts custom_hosts
    custom_hosts="server1 server2 nas"
    hosts=$(grep "^Host" ~/.ssh/config 2>/dev/null | grep -v "[?*]" | awk '{print $2}')
    _values 'hosts' $hosts $custom_hosts
}
# Only register compdef if completion system is loaded
if (( $+functions[compdef] )); then
    compdef _sssh_complete sssh
fi

# ======================================================================
# FUNCTIONS - SYSTEM MAINTENANCE
# ======================================================================

# Comprehensive system cleanup for Arch Linux
cleanup() {
    local before after freed

    echo -e "\n\e[96m╭─────────────────────────────────────────────────╮\e[0m"
    echo -e "\e[96m│\e[0m  \e[1;97mSystem Cleanup\e[0m                              \e[96m│\e[0m"
    echo -e "\e[96m╰─────────────────────────────────────────────────╯\e[0m\n"

    before=$(df --output=used / | tail -1 | tr -d ' ')

    echo -e "\e[93m[1/7]\e[0m Clearing pacman cache (keeping last 3)..."
    sudo paccache -rk3 2>/dev/null || sudo pacman -Sc --noconfirm

    echo -e "\e[93m[2/7]\e[0m Removing orphaned packages..."
    if orphans=$(pacman -Qtdq 2>/dev/null); then
        echo "$orphans" | sudo pacman -Rns --noconfirm -
    else
        echo "      No orphaned packages found"
    fi

    echo -e "\e[93m[3/7]\e[0m Clearing yay cache..."
    if command -v yay &>/dev/null; then
        yay -Sc --noconfirm 2>/dev/null
    else
        echo "      yay not installed, skipping"
    fi

    echo -e "\e[93m[4/7]\e[0m Clearing user cache..."
    rm -rf ~/.cache/* 2>/dev/null

    echo -e "\e[93m[5/7]\e[0m Clearing systemd journal (keeping 3 days)..."
    sudo journalctl --vacuum-time=3d 2>/dev/null

    echo -e "\e[93m[6/7]\e[0m Clearing temporary files..."
    sudo rm -rf /tmp/* 2>/dev/null

    echo -e "\e[93m[7/7]\e[0m Clearing thumbnails and trash..."
    rm -rf ~/.thumbnails/* ~/.local/share/Trash/* 2>/dev/null

    after=$(df --output=used / | tail -1 | tr -d ' ')
    freed=$((before - after))

    echo -e "\n\e[96m╭─────────────────────────────────────────────────╮\e[0m"
    echo -e "\e[96m│\e[0m  \e[92mCleanup Complete!\e[0m                           \e[96m│\e[0m"
    if [[ $freed -gt 0 ]]; then
        printf "\e[96m│\e[0m  \e[92mSpace freed: %-33s\e[96m│\e[0m\n" "$(numfmt --to=iec --suffix=B $((freed * 1024)))"
    else
        echo -e "\e[96m│\e[0m  \e[93mSpace freed: 0B (or negligible)\e[0m            \e[96m│\e[0m"
    fi
    echo -e "\e[96m╰─────────────────────────────────────────────────╯\e[0m\n"

    echo -e "\e[93mTop 10 largest directories:\e[0m\n"
    du -h --max-depth=2 ~/ 2>/dev/null | sort -rh | head -11 | tail -10 | nl -w2 -s'. '
    echo
}

# ======================================================================
# FUNCTIONS - WELCOME MESSAGE
# ======================================================================

_welcome_bar() {
    local greeting="Welcome back"
    local hour=$(date +%H)
    
    # Time-based greeting
    if [[ $hour -ge 5 && $hour -lt 12 ]]; then
        greeting="Good morning"
    elif [[ $hour -ge 12 && $hour -lt 17 ]]; then
        greeting="Good afternoon"
    elif [[ $hour -ge 17 && $hour -lt 22 ]]; then
        greeting="Good evening"
    else
        greeting="Burning the midnight oil"
    fi
    
    echo
    echo -e "\e[96m╭─────────────────────────────────────────────────╮\e[0m"
    printf "\e[96m│\e[0m  \e[1;97m%-45s\e[96m│\e[0m\n" "$greeting, $USER"
    echo -e "\e[96m╰─────────────────────────────────────────────────╯\e[0m"
    echo
}
